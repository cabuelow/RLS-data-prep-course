---
title: "Cleaning ecological survey data for conservation scientists"
author: "CJ Brown"
date: "17 July 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

TODO: 
Make sure I explain RLS data and caveats and how to get it
Add some errors into the data? 




# Cleaning ecological survey data for conservation scientists

## Setup for the course  

So that the course runs efficiently, and to save plenty of time for trying fun things in R, we'd ask that you come to the course prepared. 
This is an intermediate level course, so we'll assume you know how to install R and R packages. As a general guide to what we expect in terms of prior knowledge, we'll assume you can run R, load data and write basic calculations that you save in a script. We'll assume you know nothing about how to structure data, create plots or make data summaries. Even if you know about these topics, you may still find the course helpful if you are self-taught, because we'll cover the conceptual foundation of these topics. 

Please have R and Rstudio installed on your computer before starting. You'll want to save plenty of time for doing this, it can be tricky on some computers, especially if you do not have 'admin' permission on a work computer. You may need to call IT to get help. We obviously only offer limited help with such installation issues. 
The latest version of R is version 4. You are welcome to try this version. We are using 3.6.2 currently for writing this course, so there may be some minor differences. The reason we haven't updated yet is that a lot of the packages we use haven't been updated yet. 

You'll also need to install a few R packages. We're using `dplyr`, `readr`, `lubridate`, `ggplot2` and `tidyr` in this course. You can install them with this R code: 
`install.packages(c("dplyr", "readr", "lubridate", "ggplot2"))`
If that doesn't work email us with the error and we'll try to help. Otherwise, see your IT department for help. 
We're using dplyr version 1.0, which was released earlier this year. If you have an older version of dplyr the course should still work fine, but there may be some minor differences in the code. 

## Overview

3 hour intro to data wrangling with tidyverse tools. 
Covers data joins, filtering, summarizing and simple plots
Aim to explain key concepts in detal, not a comprehensive overview

Uses RLS data (link to papers )

Case-study description and narrative 

## The importance of being organized

Explain how best to organize folders/projects 

## New script

Name it, date it etc... 

```{r}

```

## Libraries 

What's a library/package? 

```{r}
library(readr)
```


## Read in data

```{r}
dat <- read_csv("data/Rottnest-Island-UVC.csv")
```

Why we use readr


## Explore the data

```{r}
names(dat)
nrow(dat)
length(unique(dat$SurveyID))
length(unique(dat$SpeciesID))
unique(dat$Sizeclass)
table(dat$Method)
```

## Filtering

Let's start by exploring data for one species, *Scarus ghobban*. 

```{r}
datscarus <- filter(dat, CURRENT_TAXONOMIC_NAME == "Scarus ghobban")
```

## First plots 

```{r}
library(ggplot2)
```

```{r}
ggplot(datscarus) + 
  aes(x = Abundance) + 
  geom_histogram()
```

Explain theory of ggplot2


```{r}
ggplot(datscarus) + 
  aes(x = Abundance, y = Biomass) +
  geom_point()
```


```{r}
ggplot(datscarus) + 
  aes(x = Abundance, y = Biomass, color = Sizeclass) +
  geom_point()
```

## Joining
```{r}
survdat <- read_csv("data/Rottnest-Island-surveys.csv")
datscarus2 <- left_join(datscarus, survdat, by = "SurveyID")
```

Explain how to avoid bugs in joins

```{r}
nrow(datscarus)
nrow(datscarus2)
```
```{r}
library(lubridate)
datscarus2$year <- year(datscarus2$SurveyDate)
```

```{r}
ggplot(datscarus2) + 
  aes(x = year, y = Abundance) + 
  geom_point()
```

```{r}
ggplot(datscarus2) + 
  aes(x = year, y = Abundance) + 
  geom_point() +
  stat_smooth()
```
Try turning off hte points,  you can see the trend better

## Join sites

```{r}
sdat <- read_csv("data/Rottnest-Island-sites.csv")
dat2 <- left_join(dat, survdat, by = "SurveyID")
nrow(dat)
length(unique(dat$SurveyID))
length(unique(dat2$SurveyID))
nrow(dat2)
dat2 <- left_join(dat2, sdat, by = "SiteCode")
nrow(dat2)
length(unique(dat2$SurveyID))
```


##Summarizing 

```{r}
dat2$year <- year(dat2$SurveyDate)
dat2g <- group_by(dat2, SurveyID)
datA <- summarize(dat2g, 
                  sum_abund = sum(Abundance, na.rm = TRUE))

```

```{r}
ggplot(datA) + 
  aes(x = sum_abund, color = NULL) +
  geom_histogram()
```

```{r}
dat3 <- filter(dat2, !is.na(TempTrop_23cutoff))
dat3g <- group_by(dat3, SurveyID, SiteCode, year, TempTrop_23cutoff)
dat4 <- summarize(dat3g, 
                  sum_abund = sum(Abundance, na.rm = TRUE))

```
```{r}
ggplot(dat4) + 
  aes(x = year, y = sum_abund, color = TempTrop_23cutoff) +
  geom_point() +
  stat_smooth()
```

## Creating new variables

```{r}
library(tidyr)
dat5 <- pivot_wider(dat4, names_from = TempTrop_23cutoff,
                    values_from = sum_abund,
                    values_fill = list(sum_abund = 0))
dat5 <- mutate(dat5, prop_trop = tropical/(temperate + tropical))

```

```{r}
ggplot(dat5) + 
  aes(x = year, y = prop_trop) +
  geom_point(aes(color = SiteCode)) + 
  stat_smooth()
```


##

```{r}
dat6g <- group_by(dat5, SiteCode, year)
dat6 <- summarize(dat6g, prop_trop = mean(prop_trop))
```

```{r}
ggplot(dat6) + 
  aes(x = year, y = prop_trop, color = SiteCode) +
  geom_line()
```



## Conclusion

Table of other tidyverse tools you might wnat to check out
